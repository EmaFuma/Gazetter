let map,borders,nearCities,wikipedia;$(window).on("load",(function(){$("#preloader").length&&$("#preloader").delay(1e3).fadeOut("slow",(function(){$(this).remove()}))}));let countryCode="",borderStyle={fillColor:"#eeedde",weight:1,opacity:.8,color:"green",fillOpacity:.2},customMarker=L.ExtraMarkers.icon({icon:"fa-building",markerColor:"green",shape:"circle",prefix:"fa"});function getCodes(){$.ajax({method:"GET",url:"php/getCountry.php",dataType:"json",success:function(result){let items=result;for(let item of items)$("#countries").append($("<option>",{value:item[1],text:item[0]}))}})}function getLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition(showPosition):alert("Position unavailable!")}function showPosition(position){const currentLatitude=position.coords.latitude,currentLongitude=position.coords.longitude;$.ajax({url:"php/getCountryCode.php",type:"GET",dataType:"json",data:{lat:currentLatitude,lng:currentLongitude},success:function(result){const isoCode=result.data.countryCode;$("#countries").val(isoCode),focus(isoCode)}})}function focus(isoCode){""!=isoCode&&(countryCode=isoCode,getBorders(isoCode),getCountryInfo(isoCode))}function numberWithPoint(num){return num.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g,".")}function getCountryInfo(isoCode){$.ajax({url:"php/getCountryInfo.php",type:"GET",dataType:"json",data:{country:isoCode},success:function(result){const info=result.data[0],name=info.countryName;$("#countryName").html(name),$("#capitalName").html(info.capital),$("#currency").html(info.currencyCode),$("#population").html(numberWithPoint(info.population)),$("#countryForecast").html(name+" Weather Forecast"),$("#covidStats").html(name+" Covid Statistics"),$("#newsTitle").html(name+" News"),$("#imageTitle").html(name+" Images"),getNews(name),getImages(name)}})}function getBorders(isoCode){$.ajax({url:"php/getBorders.php",type:"GET",dataType:"json",data:{countryCode:isoCode},success:function(result){borders.clearLayers(),borders.addData(result).setStyle(borderStyle);const bounds=borders.getBounds();map.fitBounds(bounds);const code=isoCode,north=bounds.getNorth(),south=bounds.getSouth(),west=bounds.getWest(),east=bounds.getEast();let lat,lng;north>0&&south>0||north<0&&south<0?lat=(north+south)/2:(north>0&&south<0||north<0&&south>0)&&(lat=(north-south)/2),west>0&&east>0||west<0&&east<0?lng=(west+east)/2:(west>0&&east<0||west<0&&east>0)&&(lng=(west-east)/2),getCities(north,south,west,east,code),getWeather(lat,lng),getLinks(north,south,west,east,code),getCovidStats(code)}})}function getCities(north,south,west,east,code){nearCities.clearLayers(),$.ajax({url:"php/getCities.php",type:"GET",dataType:"json",data:{north:north,south:south,west:west,east:east},success:function(result){const location=result.data.geonames;if(location)for(let i=0;i<location.length;i++){if(location[i].countrycode!==code)continue;const marker=L.marker([location[i].lat,location[i].lng],{icon:customMarker}).bindPopup("<b>"+location[i].name+"</b><br>Population: "+parseInt(location[i].population).toLocaleString("en"));nearCities.addLayer(marker)}else alert("No locations available at the moment! Use buttons for more information")}})}function getWeather(lat,lng){$("#dailyForecast").html(""),$.ajax({url:"php/getWeather.php",type:"GET",dataType:"json",data:{lat:lat,lng:lng},success:function(result){let iconUrl="https://openweathermap.org/img/w/";const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];if(0!=result.data.daily.length)for(let i=0;i<5;i++){const d=result.data.daily[i],day=days[new Date(1e3*d.dt).getDay()];$("#dailyForecast").append("<tr><td>"+day+"</td><td>"+parseInt(d.temp.max)+"°/ "+parseInt(d.temp.min)+"°</td><td>"+d.weather[0].description+"</td><td><img src='"+iconUrl+d.weather[0].icon+".png'></td></tr>")}else $("#modalForecast").html("<h5>No Weather Forecast Available!, Sorry for the trouble.</h5>")}})}function getLinks(north,south,west,east,code){$.ajax({url:"php/getLinks.php",type:"GET",dataType:"json",data:{north:north,south:south,west:west,east:east},success:function(result){const location=result.data.geonames;let wiki;if(0!=location.length){for(let i=0;i<location.length;i++)location[i].countryCode===code&&(wiki=(location[i].countryCode,"http://"+location[i].wikipediaUrl));$("#link").attr("href",wiki)}else wiki="No links available!"}})}function getCovidStats(countryCode){$.ajax({url:"php/getCovidInfo.php",type:"GET",dataType:"json",data:{countryCode:countryCode},success:function(result){const data=result.data;$("#newCases").html(numberWithPoint(data.todayCases)),$("#newDeath").html(numberWithPoint(data.todayDeaths)),$("#newRecovered").html(numberWithPoint(data.todayRecovered)),$("#totalCases").html(numberWithPoint(data.cases)),$("#totalDeaths").html(numberWithPoint(data.deaths)),$("#totalRecovered").html(numberWithPoint(data.recovered))}})}function getNews(country){$("#newsBody").html(""),$.ajax({url:"php/getNews.php",type:"GET",dataType:"json",data:{countryName:country},success:function(result){const data=result.data.articles;if(0!=data.length)for(let i=0;i<4;i++)$("#newsBody").append(addNews(data[i]));else $("#newsBody").html("<h5>No News Found! Sorry for the trouble.</h5>")}})}function addNews(data){const author=null==data.author?"Author Unknown":data.author,card='<div class="card" style="width: 18rem;"> <img class="card-img-top" src="'+data.urlToImage+'" alt="News Image"> <div class="card-body"> <h5 class="card-title">'+author+'</h5> <p class="card-text">'+data.title+'</p> <a href="'+data.url+'" target="_blank" class="btn btn-dark">Details</a> </div> </div>';return card}function getImages(country){$("#imagesBody").html(""),$.ajax({url:"php/getImages.php",type:"GET",dataType:"json",data:{countryName:country},success:function(result){const images=result.data.hits;if(0!=images.length)for(let i=0;i<5;i++)$("#imagesBody").append("<img class='countryImage' src="+images[i].webformatURL+" alt='Country Image'>");else $("#imagesBody").html("<h5>No Images Found! Sorry for the trouble.</h5>")}})}$(document).ready((function(){map=L.map("map",{zoomControl:!1}).setView([0,0],1),new L.control.zoom({position:"bottomright"}).addTo(map),L.tileLayer.provider("CartoDB.Voyager").addTo(map),map.setMaxBounds(map.getBounds()),borders=(new L.geoJson).addTo(map),nearCities=L.markerClusterGroup(),map.addLayer(nearCities),wikipedia=new L.featureGroup,map.addLayer(wikipedia),L.easyButton('<i class="material-icons">refresh</i>',(function(){window.location.reload()}),{position:"bottomright"}).addTo(map),L.easyButton('<i class="material-icons" style="color: blue";>info</i>',(function(){$("#information").modal("show")}),{position:"topleft"}).addTo(map),L.easyButton('<i class="material-icons" style="color: green";>coronavirus</i>',(function(){$("#coronavirus").modal("show")}),{position:"topleft"}).addTo(map),L.easyButton('<i class="material-icons" style="color: grey";>wb_cloudy</i>',(function(){$("#forecast").modal("show")}),{position:"topleft"}).addTo(map),L.easyButton('<i class="material-icons" style="color: black";>newspaper</i>',(function(){$("#news").modal("show")}),{position:"topleft"}).addTo(map),L.easyButton('<i class="material-icons" style="color: brown";>photo_camera</i>',(function(){$("#images").modal("show")}),{position:"topleft"}).addTo(map),getCodes(),getLocation()})),$("#countries").on("change",(function(){const value=this.value;focus(value)}));